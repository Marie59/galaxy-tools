<tool id="cads" name="Copernicus Atmosphere Data Store" version="0.1.1" profile="25.1">
    <description>for retrieving data from the Atmosphere Monitoring Service</description>
    <requirements>
        <requirement type="package" version="3">python</requirement>
        <requirement type="package" version="0.5.1">cdsapi</requirement>
        <requirement type="package" version="1.9.9">cdo</requirement>
        <requirement type="package" version="1.34">tar</requirement>
        <requirement type="package" version="6.0">unzip</requirement>
	<credentials name="cads_apikey" version="1.0" label="CADS API key" description="Credential for accessing Copernicus atmosphere Data Store API.">
            <secret name="key" inject_as_env="CADS_API_KEY" optional="false" label="CADS API key" description="Your Copernicus atmosphere Data Store API key."/>
        </credentials>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        export HOME=`pwd`  &&

        python3 '$__tool_directory__/cads_retrieve.py' 
        #if str($is_file.has_req).strip() == 'yes'
            --request '$is_file.api_req_file' 
        #else
            --request '$req_from_paste'
        #end if
        --output request.txt &&
        bash '$__tool_directory__/cads.sh' &&
        echo "Data retrieval from Copernicus Atmosphere Data Store is done"
    ]]></command>
    <configfiles>
        <configfile name="req_from_paste"><![CDATA[
       #if str($is_file.has_req).strip() == 'no'
$is_file.api_req_text
       #end if
        ]]></configfile>
    </configfiles>
    <inputs>
        <conditional name="is_file">
            <param name="has_req" type="select" label="Provide CADS request">
                <option value="no">paste as text</option>
                <option value="yes" selected="true">give a filename</option>
            </param>
            <when value="yes">
                <param name="api_req_file" type="data" label="API Request filename" format="txt"/>
            </when>
            <when value="no">
                <param name="api_req_text" type="text" label="Paste API Request" area="true" />
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="request" format="txt" from_work_dir="request.txt"/>
        <data name="ofilename" format="netcdf" from_work_dir="tmp.nc"/>
    </outputs>
    <tests>
        <test expect_failure="true">
            <conditional name="is_file">
                <param name="has_req" value="yes" />
                <param name="api_req_file" ftype="txt" value="req.txt" />
            </conditional>
            <assert_stderr>
                <has_text text="CADS retrieval failed, make sure you filled in your CADS API Key"/>
            </assert_stderr>
        </test>
        <test expect_failure="true">
            <conditional name="is_file">
                <param name="has_req" value="yes" />
                <param name="api_req_file" ftype="txt" value="req-timeseries.txt" />
            </conditional>
            <assert_stderr>
                <has_text text="CADS retrieval failed, make sure you filled in your CADS API Key"/>
            </assert_stderr>
        </test>
    </tests>
    <help><![CDATA[

**Copernicus Atmosphere Data Store (ADS)**
=======================================================================================================

This tool is a wrapper to retrieve data from the Copernicus Atmosphere Data Store.

- It allows to retrieve data from the Copernicus Atmosphere Monitoring Service.
- Any user willing to use this tool needs to `create a new account here <https://ads.atmosphere.copernicus.eu/>`_.
- Set your CADS API Key in the credentials
- Your CADS API key can be found `here <https://ads.atmosphere.copernicus.eu/profile>`_.
- Compose your request directly on Copernicus Atmosphere Data Store and copy/paste it in the input field "Request" or save it in a file mor information on how to proceed in the `documentation <https://ads.atmosphere.copernicus.eu/user-guide>` .
- Be aware that for being able to download dataset from ADS, users also need to agree to their term of use (Licence to use Copernicus Products) on the ADS website.

License:
~~~~~~~~

Generated using Copernicus Atmosphere Monitoring Service information [2021]
Neither the European Commission nor ECMWF is responsible for any use 
that may be made of the Copernicus information or data it contains.
    ]]></help>
    <citations>
    </citations>
    <edam_topics>
      <edam_topic>topic_3855</edam_topic>
      <edam_topic>topic_3318</edam_topic>
    </edam_topics>
    <edam_operations>
      <edam_operation>operation_2422</edam_operation>
      <edam_operation>operation_3357</edam_operation>
      <edam_operation>operation_0335</edam_operation>
    </edam_operations>
</tool>
